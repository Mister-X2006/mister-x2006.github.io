<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Einkaufsliste Smart</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Arial; margin:20px; transition:.3s; }
.dark { background:#121212; color:white; }

button {
    padding:10px 14px;
    margin:4px;
    border:none;
    border-radius:30px;
    cursor:pointer;
    font-weight:bold;
    transition:.2s;
}

button:hover { opacity:0.8; }

.primary { background:#4CAF50; color:white; }
.secondary { background:#2196F3; color:white; }
.danger { background:#f44336; color:white; }
.theme { background:#555; color:white; }

input {
    padding:8px;
    margin:4px;
    border-radius:20px;
    border:1px solid #ccc;
}

.item {
    display:flex;
    justify-content:space-between;
    padding:8px;
    border-bottom:1px solid #ccc;
}
.done { text-decoration:line-through; opacity:0.6; }

#reader { width:300px; margin-top:15px; }
</style>
</head>
<body>

<h1>
ðŸ›’ Einkaufsliste
<button class="theme" onclick="toggleTheme()">ðŸŒ™/â˜€</button>
</h1>

<p>Datum: <span id="date"></span></p>

<hr>

<h3>Produkt-Typ manuell hinzufÃ¼gen</h3>
<input id="typeInput" placeholder="z.B. Milch, Brot">
<button class="primary" onclick="addType()">HinzufÃ¼gen</button>

<hr>

<h3>Alternative: Per Scan hinzufÃ¼gen</h3>
<button class="secondary" onclick="scanAndAdd()">ðŸ“· HinzufÃ¼gen (Scan)</button>

<hr>

<h3>Produkt als gekauft markieren</h3>
<button class="primary" onclick="scanToComplete()">âœ” Als gekauft scannen</button>

<div id="reader"></div>

<hr>

<div id="list"></div>

<script>
document.getElementById("date").innerText =
new Date().toLocaleDateString("de-DE");

let items = JSON.parse(localStorage.getItem("items") || "[]");

function save(){
    localStorage.setItem("items", JSON.stringify(items));
}

function render(){
    const list = document.getElementById("list");
    list.innerHTML="";

    items.forEach(item=>{
        const div = document.createElement("div");
        div.className="item";
        div.innerHTML=`
            <span class="${item.done?'done':''}">
                ${item.type}
            </span>
            <div>
                <button class="primary" onclick="toggle('${item.id}')">âœ”</button>
                <button class="danger" onclick="removeItem('${item.id}')">âœ–</button>
            </div>
        `;
        list.appendChild(div);
    });
}

function addType(){
    const type = document.getElementById("typeInput").value.trim();
    if(!type) return;

    items.push({
        id:crypto.randomUUID(),
        type:type.toLowerCase(),
        done:false
    });

    document.getElementById("typeInput").value="";
    save();
    render();
}

function toggle(id){
    items = items.map(i=>{
        if(i.id===id) i.done=!i.done;
        return i;
    });
    save();
    render();
}

function removeItem(id){
    items = items.filter(i=>i.id!==id);
    save();
    render();
}

function scan(barcodeCallback){
    const reader = new Html5Qrcode("reader");
    reader.start(
        { facingMode:"environment" },
        { fps:10, qrbox:250 },
        code=>{
            reader.stop();
            barcodeCallback(code);
        }
    ).catch(()=>alert("Kamera nicht verfÃ¼gbar"));
}

function scanAndAdd(){
    scan(barcode=>{
        fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`)
        .then(res=>res.json())
        .then(data=>{
            if(data.status===1){
                const name =
                    (data.product.categories || "").split(",")[0]
                    || data.product.product_name
                    || "Unbekannt";

                items.push({
                    id:crypto.randomUUID(),
                    type:name.toLowerCase(),
                    done:false
                });

                save();
                render();
            } else {
                alert("Produkt nicht gefunden.");
            }
        });
    });
}

function scanToComplete(){
    scan(barcode=>{
        fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`)
        .then(res=>res.json())
        .then(data=>{
            if(data.status===1){
                const categories =
                    (data.product.categories || "").toLowerCase();

                const match = items.find(i =>
                    categories.includes(i.type) && !i.done
                );

                if(match){
                    match.done=true;
                    alert("Erledigt: " + match.type);
                } else {
                    alert("Kein passender Typ auf Liste.");
                }

                save();
                render();
            } else {
                alert("Produkt nicht gefunden.");
            }
        });
    });
}

function toggleTheme(){
    document.body.classList.toggle("dark");
    localStorage.setItem("theme",
        document.body.classList.contains("dark")?"dark":"light");
}

if(localStorage.getItem("theme")==="dark")
    document.body.classList.add("dark");

render();
</script>

</body>
</html>
