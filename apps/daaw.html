<!DOCTYPE html><html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MIDI Piano Roll</title><style>

body{
margin:0;
font-family:system-ui;
background:#181a1f;
color:white;
overflow:hidden;
}

#topbar{
display:flex;
gap:10px;
align-items:center;
padding:10px;
background:#20242b;
border-bottom:1px solid #333;
}

button,select,input{
background:#2b3038;
color:white;
border:1px solid #444;
border-radius:8px;
padding:6px 10px;
}

button:hover{
background:#3b4048;
}

#layout{
display:flex;
height:calc(100vh - 60px);
}

#tracks{
width:240px;
background:#20242b;
overflow:auto;
border-right:1px solid #333;
}

.track{
padding:10px;
border-bottom:1px solid #333;
cursor:pointer;
display:flex;
flex-direction:column;
gap:6px;
}

.track.active{
background:#2f3540;
}

.instrumentLabel{
font-size:12px;
opacity:.7;
}

#main{
flex:1;
position:relative;
overflow:auto;
}

canvas{
background:#121418;
display:block;
}

.panel{
padding:8px;
background:#20242b;
border-bottom:1px solid #333;
}

.hidden{
display:none;
}

</style></head>
<body><div id="topbar"><button onclick="togglePanel()">☰ Menü</button>

<button onclick="addTrack()">+ Spur</button>

<select id="instrumentSelect"></select>

<select id="outputMode">
<option value="internal">Synth</option>
<option value="midi">MIDI Gerät</option>
</select><select id="midiDevices"></select>

<button onclick="playSong()">▶ Play</button>

<span id="deviceType"></span>

</div><div id="menu" class="panel">
Zoom <input type="range" min="20" max="120" value="60" id="zoom">
</div><div id="layout"><div id="tracks"></div><div id="main">
<canvas id="roll" width="4000" height="2000"></canvas>
</div></div><script>

let audioCtx;

function initAudio(){
if(!audioCtx)
audioCtx=new AudioContext();
}

const instruments=[
"Acoustic Grand Piano","Electric Piano","Organ","Guitar","Bass",
"Strings","Choir","Trumpet","Sax","Flute","Synth","Pad"
];

let midiAccess=null;
let midiOutput=null;

navigator.requestMIDIAccess?.({sysex:false}).then(access=>{

midiAccess=access;

let sel=document.getElementById("midiDevices");
sel.innerHTML="";

access.outputs.forEach(out=>{

let opt=document.createElement("option");
opt.text=out.name;
opt.value=out.id;
sel.appendChild(opt);

});

sel.onchange=()=>{

midiOutput=midiAccess.outputs.get(sel.value);

};

if(sel.options.length>0){

midiOutput=midiAccess.outputs.get(sel.options[0].value);

}

});

let tracks=[];
let activeTrack=0;

const canvas=document.getElementById("roll");
const ctx=canvas.getContext("2d");
const trackDiv=document.getElementById("tracks");

function togglePanel(){
document.getElementById("menu").classList.toggle("hidden");
}

function addTrack(){
tracks.push({
notes:[],
instrument:0
});
activeTrack=tracks.length-1;
updateTracks();
}

function updateTracks(){
trackDiv.innerHTML="";

tracks.forEach((t,i)=>{

let d=document.createElement("div");

let name=document.createElement("div");
name.textContent="Spur "+(i+1);

let inst=document.createElement("div");
inst.textContent=instruments[t.instrument];
inst.className="instrumentLabel";


d.className="track"+(i===activeTrack?" active":"");


d.appendChild(name);
d.appendChild(inst);


d.onclick=()=>{
activeTrack=i;
updateTracks();
};

trackDiv.appendChild(d);

});

}

function draw(){

let zoom=document.getElementById("zoom").value;

ctx.clearRect(0,0,canvas.width,canvas.height);


for(let x=0;x<canvas.width;x+=zoom){

ctx.strokeStyle="#2a2e36";
ctx.beginPath();
ctx.moveTo(x,0);
ctx.lineTo(x,canvas.height);
ctx.stroke();

}

for(let y=0;y<canvas.height;y+=24){

ctx.strokeStyle="#1d2026";
ctx.beginPath();
ctx.moveTo(0,y);
ctx.lineTo(canvas.width,y);
ctx.stroke();

}

if(tracks[activeTrack]){

tracks[activeTrack].notes.forEach(n=>{

ctx.fillStyle="#5aa2ff";
ctx.fillRect(n.x,n.y,n.w,22);

});

}

}

canvas.onclick=e=>{

initAudio();

let rect=canvas.getBoundingClientRect();

let x=e.clientX-rect.left;
let y=e.clientY-rect.top;

let note={x:x,y:y,w:120};

tracks[activeTrack].notes.push(note);

playNote(note);

draw();

};

function midiNoteNumber(y){

return 84-Math.floor(y/24);

}

function playNote(note){

let n=midiNoteNumber(note.y);

let mode=document.getElementById("outputMode").value;

if(mode==="internal"){

let osc=audioCtx.createOscillator();
let gain=audioCtx.createGain();

osc.type="sawtooth";

osc.frequency.value=440*Math.pow(2,(n-69)/12);

gain.gain.value=.2;

osc.connect(gain);
gain.connect(audioCtx.destination);

osc.start();
osc.stop(audioCtx.currentTime+.4);

}

if(mode==="midi" && midiOutput){

midiOutput.send([0x90,n,100]);
setTimeout(()=>midiOutput.send([0x80,n,0]),400);

}

}

function playSong(){

let time=0;

tracks.forEach(track=>{

track.notes.forEach(note=>{

setTimeout(()=>playNote(note),note.x*2);

});

});

}

function populateInstruments(){

let s=document.getElementById("instrumentSelect");

instruments.forEach((i,n)=>{

let o=document.createElement("option");

o.value=n;
o.text=i;

s.appendChild(o);

});

s.onchange=()=>{

tracks[activeTrack].instrument=parseInt(s.value);
updateTracks();

};

}

populateInstruments();

function detectDevice(){

let w=window.innerWidth;

let t="PC";

if(w<700)t="Telefon";
else if(w<1100)t="Tablet";

document.getElementById("deviceType").textContent=t;

}

detectDevice();

setInterval(draw,200);

addTrack();

</script></body>
</html>
